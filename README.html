<!doctype html>
<html>
  <head>
    <title>README.md</title>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />

    <style>
      /* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
      /*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

      body {
        font-family: var(
          --vscode-markdown-font-family,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe WPC",
          "Segoe UI",
          "Ubuntu",
          "Droid Sans",
          sans-serif
        );
        font-size: var(--vscode-markdown-font-size, 14px);
        padding: 0 26px;
        line-height: var(--vscode-markdown-line-height, 22px);
        word-wrap: break-word;
      }

      #code-csp-warning {
        position: fixed;
        top: 0;
        right: 0;
        color: white;
        margin: 16px;
        text-align: center;
        font-size: 12px;
        font-family: sans-serif;
        background-color: #444444;
        cursor: pointer;
        padding: 6px;
        box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.25);
      }

      #code-csp-warning:hover {
        text-decoration: none;
        background-color: #007acc;
        box-shadow: 2px 2px 2px rgba(0, 0, 0, 0.25);
      }

      body.scrollBeyondLastLine {
        margin-bottom: calc(100vh - 22px);
      }

      body.showEditorSelection .code-line {
        position: relative;
      }

      body.showEditorSelection .code-active-line:before,
      body.showEditorSelection .code-line:hover:before {
        content: "";
        display: block;
        position: absolute;
        top: 0;
        left: -12px;
        height: 100%;
      }

      body.showEditorSelection li.code-active-line:before,
      body.showEditorSelection li.code-line:hover:before {
        left: -30px;
      }

      .vscode-light.showEditorSelection .code-active-line:before {
        border-left: 3px solid rgba(0, 0, 0, 0.15);
      }

      .vscode-light.showEditorSelection .code-line:hover:before {
        border-left: 3px solid rgba(0, 0, 0, 0.4);
      }

      .vscode-light.showEditorSelection .code-line .code-line:hover:before {
        border-left: none;
      }

      .vscode-dark.showEditorSelection .code-active-line:before {
        border-left: 3px solid rgba(255, 255, 255, 0.4);
      }

      .vscode-dark.showEditorSelection .code-line:hover:before {
        border-left: 3px solid rgba(255, 255, 255, 0.6);
      }

      .vscode-dark.showEditorSelection .code-line .code-line:hover:before {
        border-left: none;
      }

      .vscode-high-contrast.showEditorSelection .code-active-line:before {
        border-left: 3px solid rgba(255, 160, 0, 0.7);
      }

      .vscode-high-contrast.showEditorSelection .code-line:hover:before {
        border-left: 3px solid rgba(255, 160, 0, 1);
      }

      .vscode-high-contrast.showEditorSelection
        .code-line
        .code-line:hover:before {
        border-left: none;
      }

      img {
        max-width: 100%;
        max-height: 100%;
      }

      a {
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      a:focus,
      input:focus,
      select:focus,
      textarea:focus {
        outline: 1px solid -webkit-focus-ring-color;
        outline-offset: -1px;
      }

      hr {
        border: 0;
        height: 2px;
        border-bottom: 2px solid;
      }

      h1 {
        padding-bottom: 0.3em;
        line-height: 1.2;
        border-bottom-width: 1px;
        border-bottom-style: solid;
      }

      h1,
      h2,
      h3 {
        font-weight: normal;
      }

      table {
        border-collapse: collapse;
      }

      table > thead > tr > th {
        text-align: left;
        border-bottom: 1px solid;
      }

      table > thead > tr > th,
      table > thead > tr > td,
      table > tbody > tr > th,
      table > tbody > tr > td {
        padding: 5px 10px;
      }

      table > tbody > tr + tr > td {
        border-top: 1px solid;
      }

      blockquote {
        margin: 0 7px 0 5px;
        padding: 0 16px 0 10px;
        border-left-width: 5px;
        border-left-style: solid;
      }

      code {
        font-family:
          Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace,
          "Droid Sans Fallback";
        font-size: 1em;
        line-height: 1.357em;
      }

      body.wordWrap pre {
        white-space: pre-wrap;
      }

      pre:not(.hljs),
      pre.hljs code > div {
        padding: 16px;
        border-radius: 3px;
        overflow: auto;
      }

      pre code {
        color: var(--vscode-editor-foreground);
        tab-size: 4;
      }

      /** Theming */

      .vscode-light pre {
        background-color: rgba(220, 220, 220, 0.4);
      }

      .vscode-dark pre {
        background-color: rgba(10, 10, 10, 0.4);
      }

      .vscode-high-contrast pre {
        background-color: rgb(0, 0, 0);
      }

      .vscode-high-contrast h1 {
        border-color: rgb(0, 0, 0);
      }

      .vscode-light table > thead > tr > th {
        border-color: rgba(0, 0, 0, 0.69);
      }

      .vscode-dark table > thead > tr > th {
        border-color: rgba(255, 255, 255, 0.69);
      }

      .vscode-light h1,
      .vscode-light hr,
      .vscode-light table > tbody > tr + tr > td {
        border-color: rgba(0, 0, 0, 0.18);
      }

      .vscode-dark h1,
      .vscode-dark hr,
      .vscode-dark table > tbody > tr + tr > td {
        border-color: rgba(255, 255, 255, 0.18);
      }
    </style>

    <style>
      /* Tomorrow Theme */
      /* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
      /* Original theme - https://github.com/chriskempson/tomorrow-theme */

      /* Tomorrow Comment */
      .hljs-comment,
      .hljs-quote {
        color: #8e908c;
      }

      /* Tomorrow Red */
      .hljs-variable,
      .hljs-template-variable,
      .hljs-tag,
      .hljs-name,
      .hljs-selector-id,
      .hljs-selector-class,
      .hljs-regexp,
      .hljs-deletion {
        color: #c82829;
      }

      /* Tomorrow Orange */
      .hljs-number,
      .hljs-built_in,
      .hljs-builtin-name,
      .hljs-literal,
      .hljs-type,
      .hljs-params,
      .hljs-meta,
      .hljs-link {
        color: #f5871f;
      }

      /* Tomorrow Yellow */
      .hljs-attribute {
        color: #eab700;
      }

      /* Tomorrow Green */
      .hljs-string,
      .hljs-symbol,
      .hljs-bullet,
      .hljs-addition {
        color: #718c00;
      }

      /* Tomorrow Blue */
      .hljs-title,
      .hljs-section {
        color: #4271ae;
      }

      /* Tomorrow Purple */
      .hljs-keyword,
      .hljs-selector-tag {
        color: #8959a8;
      }

      .hljs {
        display: block;
        overflow-x: auto;
        color: #4d4d4c;
        padding: 0.5em;
      }

      .hljs-emphasis {
        font-style: italic;
      }

      .hljs-strong {
        font-weight: bold;
      }
    </style>

    <style>
      /*
 * Markdown PDF CSS
 */

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu",
          "Droid Sans", sans-serif, "Meiryo";
        padding: 0 12px;
      }

      pre {
        background-color: #f8f8f8;
        border: 1px solid #cccccc;
        border-radius: 3px;
        overflow-x: auto;
        white-space: pre-wrap;
        overflow-wrap: break-word;
      }

      pre:not(.hljs) {
        padding: 23px;
        line-height: 19px;
      }

      blockquote {
        background: rgba(127, 127, 127, 0.1);
        border-color: rgba(0, 122, 204, 0.5);
      }

      .emoji {
        height: 1.4em;
      }

      code {
        font-size: 14px;
        line-height: 19px;
      }

      /* for inline code */
      :not(pre):not(.hljs) > code {
        color: #c9ae75; /* Change the old color so it seems less like an error */
        font-size: inherit;
      }

      /* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
      .page {
        page-break-after: always;
      }
    </style>

    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs"
    ></script>
  </head>
  <body>
    <script>
      mermaid.initialize({
        startOnLoad: true,
        theme:
          document.body.classList.contains("vscode-dark") ||
          document.body.classList.contains("vscode-high-contrast")
            ? "dark"
            : "default",
      });
    </script>
    <h1 id="petto">Petto</h1>
    <p>
      Petto is a Progressive Web Application designed to help reunite lost pets
      with their owners.
    </p>
    <h2 id="features">Features</h2>
    <ul>
      <li><strong>Login, Logout, Register and Password recovery</strong></li>
      <li>
        <strong>Create a Collection of Pets</strong>
        <ul>
          <li>Add, Edit, Read, Remove a Pet</li>
          <li>
            Generate Pet QR Code in square or circle canvas to print and glue in
            the pet medal
          </li>
        </ul>
      </li>
      <li>
        <strong>Generate Pet Flyers and A4 Posters</strong>
        <ul>
          <li>
            The user could create print ready flyers of lost pet. It must
            include pet picture, description, indications and pet QR code.
          </li>
        </ul>
      </li>
    </ul>
    <h2 id="monorepo-structure">Monorepo Structure</h2>
    <p>Petto is organized as a monorepo using pnpm workspaces:</p>
    <ul>
      <li><code>backend/</code>: FastAPI backend (Python)</li>
      <li><code>apps/frontend/</code>: SvelteKit frontend (TypeScript)</li>
      <li>
        <code>packages/</code>: (optional) Shared libraries or modules (e.g.,
        <code>packages/shared/</code>)
      </li>
    </ul>
    <p>Workspace configuration: see <code>pnpm-workspace.yaml</code></p>
    <h2 id="technologies">Technologies</h2>
    <ul>
      <li>
        <strong>Backend:</strong> Python 3, FastAPI, SQLite (scalable to
        MySQL/PostgreSQL)
      </li>
      <li>
        <strong>Frontend:</strong> SvelteKit 5, Prisma ORM, Tailwind CSS,
        Paraglide i18n
      </li>
    </ul>
    <h2 id="backend-setup--start-guide">Backend Setup &amp; Start Guide</h2>
    <h3 id="prerequisites">Prerequisites</h3>
    <ul>
      <li>Python 3.8+</li>
      <li>
        (Recommended) Virtual environment tool: <code>venv</code> or
        <code>virtualenv</code>
      </li>
    </ul>
    <h3 id="installation">Installation</h3>
    <ol>
      <li>
        Navigate to the backend app directory:
        <pre
          class="hljs"
        ><code><div><span class="hljs-built_in">cd</span> backend
</div></code></pre>
      </li>
      <li>
        Create and activate a virtual environment (optional but recommended):
        <pre class="hljs"><code><div>python3 -m venv venv
<span class="hljs-built_in">source</span> venv/bin/activate
</div></code></pre>
      </li>
      <li>
        Install dependencies:
        <pre class="hljs"><code><div>pip install -r requirements.txt
</div></code></pre>
      </li>
    </ol>
    <h3 id="running-the-backend">Running the Backend</h3>
    <p>Start the FastAPI server using Uvicorn:</p>
    <pre class="hljs"><code><div>uvicorn main:app --reload
</div></code></pre>
    <ul>
      <li>The API will be available at <code>http://127.0.0.1:8000</code></li>
      <li>Health check endpoint: <code>GET /_health</code></li>
    </ul>
    <h2 id="project-structure">Project Structure</h2>
    <ul>
      <li><code>backend/main.py</code>: FastAPI application entry point</li>
      <li>
        <code>backend/routers/</code>: API route modules (users, pets, qrcode,
        banners, pet_location)
      </li>
      <li><code>backend/models.py</code>: Database models</li>
      <li><code>backend/database.py</code>: Database configuration</li>
      <li><code>apps/frontend/</code>: SvelteKit frontend app</li>
    </ul>
    <h2 id="autenticaci%C3%B3n-y-autorizaci%C3%B3n-end-to-end">
      Autenticación y autorización (end-to-end)
    </h2>
    <p>
      Este proyecto implementa autenticación basada en JWT con tokens de acceso
      (corto plazo) y tokens de refresco (largo plazo), más autorización en
      rutas del frontend. El flujo cubre inicio de sesión, acceso a páginas
      protegidas, refresco automático del token y cierre de sesión.
    </p>
    <ul>
      <li>
        <p>Backend (FastAPI):</p>
        <ul>
          <li>
            <code>POST /api/login</code>: emite <code>access_token</code> y
            <code>refresh_token</code>.
          </li>
          <li>
            <code>GET /api/users/me</code>: devuelve el usuario autenticado
            (requiere <code>Authorization: Bearer &lt;access_token&gt;</code>).
          </li>
          <li>
            <code>POST /api/token/refresh</code>: intercambia un
            <code>refresh_token</code> válido por un nuevo
            <code>access_token</code> (y opcionalmente nuevo
            <code>refresh_token</code>).
          </li>
        </ul>
      </li>
      <li>
        <p>Frontend (SvelteKit 5):</p>
        <ul>
          <li>
            Helper centralizado <code>src/lib/utils/api.ts</code>: añade
            <code>Authorization</code> cuando <code>requireAuth: true</code>,
            usa el <code>fetch</code> de <code>load</code> si se le pasa, y
            refresca automáticamente al recibir 401.
          </li>
          <li>
            Layout <code>routes/+layout.ts</code>: durante <code>load</code>,
            consulta <code>api/users/me</code> mediante el helper; si no hay
            sesión/tokens válidos, las páginas protegidas redirigen a
            <code>/login</code> con <code>returnUrl</code>.
          </li>
          <li>
            Guardia SSR opcional <code>src/lib/utils/protect-route.ts</code>:
            para +page.ts protegidas, valida la sesión del layout y redirige si
            no existe.
          </li>
          <li>
            Guardia de cliente
            <code>src/lib/components/ProtectedRoute.svelte</code>: asegura que
            el usuario esté autenticado al renderizar contenido protegido en el
            cliente.
          </li>
          <li>
            Almacén de sesión <code>src/lib/stores/session.ts</code>: guarda el
            usuario actual; los tokens se almacenan en
            <code>localStorage</code>.
          </li>
        </ul>
      </li>
    </ul>
    <h3 id="secuencia-completa-mermaid">Secuencia completa (Mermaid)</h3>
    <pre><code class="language-mermaid"><div class="mermaid">sequenceDiagram
   autonumber
   actor U as Usuario
   participant FE as SvelteKit (Frontend)
   participant AH as API Helper (api.ts)
   participant LS as TokenStore (localStorage)
   participant BE as Backend (FastAPI)

   Note over U,FE: Acceso a página protegida (ej. /pets)
   U->>FE: Navega a ruta
   FE->>AH: +layout load → GET api/users/me { requireAuth: true, fetchFn }
   alt Sin tokens en LS
      AH-->>FE: 401/No auth
      FE-->>U: Redirige a /login?returnUrl=...
   else Con access_token en LS
      AH->>BE: GET /api/users/me (Bearer access_token)
      alt 200 OK
         BE-->>AH: Datos de usuario
         AH-->>FE: user
         FE->>LS: (Opcional) tokens ya presentes
         FE-->>U: Renderiza página
      else 401 (expirado)
         BE-->>AH: 401 Unauthorized
         AH->>BE: POST /api/token/refresh { refresh_token }
         alt 200 OK (refresh válido)
            BE-->>AH: Nuevo access_token (+ opcional refresh_token)
            AH->>LS: Actualiza tokens
            AH->>BE: Reintenta GET /api/users/me
            BE-->>AH: 200 + user
            AH-->>FE: user
            FE-->>U: Renderiza página
         else 401/400 (refresh inválido)
            BE-->>AH: Error de refresh
            AH->>LS: Limpia tokens
            FE-->>U: Redirige a /login?returnUrl=...
         end
      end
   end

   Note over U,FE: Inicio de sesión
   U->>FE: Envía credenciales
   FE->>BE: POST /api/login { email, password }
   alt Credenciales válidas
      BE-->>FE: access_token + refresh_token
      FE->>LS: Guarda tokens
      FE-->>U: Redirige a returnUrl o home
   else Inválidas
      BE-->>FE: 401 Unauthorized
      FE-->>U: Muestra error
   end

   Note over U,FE: Cierre de sesión
   U->>FE: Click en logout
   FE->>LS: Elimina access_token y refresh_token
   FE-->>U: Redirige a /login
</div></code></pre>
    <h3 id="detalles-y-mejores-pr%C3%A1cticas">Detalles y mejores prácticas</h3>
    <ul>
      <li>
        En <code>api.ts</code>, usa siempre <code>fetchFn</code> del
        <code>load</code> de SvelteKit cuando esté disponible para evitar
        warnings y mantener SSR consistente.
      </li>
      <li>
        Todas las llamadas autenticadas deberían pasar por el helper (<code
          >requireAuth: true</code
        >) para beneficiarse del refresco automático.
      </li>
      <li>
        Las páginas protegidas pueden combinar: comprobación en
        <code>+layout.ts</code> (hidrata la sesión),
        <code>protect-route.ts</code> para SSR y
        <code>ProtectedRoute.svelte</code> en cliente.
      </li>
      <li>
        En fallo de refresh, se limpian tokens y se redirige a
        <code>/login?returnUrl=...</code>.
      </li>
      <li>
        Los mensajes de UI e i18n se gestionan con Paraglide; el almacén de
        sesión mantiene el usuario actual.
      </li>
    </ul>
    <h2 id="frontend-setup--start-guide">Frontend Setup &amp; Start Guide</h2>
    <h3 id="technologies">Technologies</h3>
    <ul>
      <li><strong>Framework:</strong> SvelteKit 5</li>
      <li><strong>Styling:</strong> Tailwind CSS</li>
      <li><strong>ORM:</strong> Prisma (for data modeling)</li>
      <li><strong>i18n:</strong> Paraglide</li>
    </ul>
    <h3 id="installation">Installation</h3>
    <ol>
      <li>
        Navigate to the frontend app directory:
        <pre
          class="hljs"
        ><code><div><span class="hljs-built_in">cd</span> apps/frontend
</div></code></pre>
      </li>
      <li>
        Install dependencies:
        <pre class="hljs"><code><div>pnpm install
<span class="hljs-comment"># or</span>
npm install
<span class="hljs-comment"># or</span>
yarn install
</div></code></pre>
      </li>
    </ol>
    <h3 id="running-the-frontend">Running the Frontend</h3>
    <p>Start the SvelteKit dev server:</p>
    <pre class="hljs"><code><div>pnpm run dev
<span class="hljs-comment"># or</span>
npm run dev
<span class="hljs-comment"># or</span>
yarn dev
</div></code></pre>
    <ul>
      <li>
        The app will be available at
        <code>http://localhost:5173</code> (default)
      </li>
    </ul>
    <h3 id="building--preview">Building &amp; Preview</h3>
    <p>To build for production:</p>
    <pre class="hljs"><code><div>pnpm run build
</div></code></pre>
    <p>To preview the production build:</p>
    <pre class="hljs"><code><div>pnpm run preview
</div></code></pre>
    <h3 id="project-structure">Project Structure</h3>
    <ul>
      <li><code>apps/frontend/src/routes/</code>: Main SvelteKit routes</li>
      <li>
        <code>apps/frontend/src/lib/paraglide/messages/</code>: i18n message
        files (auto-generated JS exports)
      </li>
      <li><code>apps/frontend/app.css</code>: Tailwind CSS entry</li>
      <li>
        <code>apps/frontend/package.json</code>: Project dependencies and
        scripts
      </li>
    </ul>
    <h3 id="developer-workflows">Developer Workflows</h3>
    <ul>
      <li>Unit tests: <code>pnpm run test:unit</code> (Vitest)</li>
      <li>E2E tests: <code>pnpm run test:e2e</code> (Playwright)</li>
      <li>
        Lint/format: <code>pnpm run lint</code>, <code>pnpm run format</code>
      </li>
    </ul>
    <h3 id="i18n-paraglide">i18n (Paraglide)</h3>
    <ul>
      <li>
        Messages are imported as named exports and called as functions (e.g.,
        <code>m.button_cancel()</code>).
      </li>
      <li>
        Locale switching: <code>setLocale('en')</code>, etc. Messages update
        reactively if used via Svelte stores.
      </li>
    </ul>
    <h2 id="additional-notes">Additional Notes</h2>
    <ul>
      <li>
        The backend uses SQLite by default. For production, consider switching
        to MySQL or PostgreSQL.
      </li>
      <li>
        API documentation is available at <code>/docs</code> when the server is
        running.
      </li>
    </ul>
    <h2 id="monorepo-commands">Monorepo Commands</h2>
    <ul>
      <li>
        Install all dependencies for all apps/packages:
        <pre class="hljs"><code><div>pnpm install
</div></code></pre>
      </li>
      <li>
        Run backend:
        <pre
          class="hljs"
        ><code><div> <span class="hljs-built_in">cd</span> backend
uvicorn main:app --reload
</div></code></pre>
      </li>
      <li>
        Run frontend:
        <pre
          class="hljs"
        ><code><div><span class="hljs-built_in">cd</span> apps/frontend
pnpm run dev
</div></code></pre>
      </li>
    </ul>
    <h2 id="contributing">Contributing</h2>
    <p>Pull requests and suggestions are welcome!</p>
    <h2 id="license">License</h2>
    <p>Specify your license here.</p>
  </body>
</html>
